# Журнал освоения фреймворка [OpenSpec](https://github.com/Fission-AI/OpenSpec)

## План освоения

- ☑ [Создание конституции проекта](#создание-конституции-проекта)
- ☑ [Создание изолированного первого изменения в проекте через исполнение всех шагов последовательно](#создание-первого-изменения)
- ☐ Модернизация конституции проекта с учетом недостатков выявленных при создании первого изменения
- ☐ Создание изолированного второго изменения в проекте через исполнение всех шагов последовательно
- ☐ Модернизация конституции проекта с учетом недостатков выявленных при создании второго изменения
- ☐ Модернизация первого и второго изменений одновременно
- ☐ Подведение итогов

Версия:

- OpenSpec Version: 0.16.0
- Python: 3.14.2

## Журнал наблюдений

### Инициализация проекта

#### Commit [d51206a975f6be7ac307c3603f65b8b710ff0443](https://github.com/retverd/demo-open-spec-with-cursor/commit/d51206a975f6be7ac307c3603f65b8b710ff0443)

Инициализировал проект, все прошло без конфликтов или ошибок:

```bash
openspec init
```

### Создание конституции проекта

#### Commit [c5859c14c9518810a707de9ad6bb3864165de3a5](https://github.com/retverd/demo-open-spec-with-cursor/commit/c5859c14c9518810a707de9ad6bb3864165de3a5)

```prompt
[Model GPT-5.2] Прочитай openspec/project.md и помоги мне заполнить его деталями о моём проекте, архитектуре, технологическом стеке и соглашениями. Спрашивай и пиши **только** на русском.
```

> **Что сделано**
>
> - Обновил `openspec/project.md`: зафиксировал **цель проекта** (котировки МосБиржи + курсы ЦБ РФ), что это **публичный туториал**, **Python**, запуск **локально**, хранение в **файлы**, тестирование (**unit** + **интеграционные с реальными системами**), Git‑процесс (**feature‑ветки + PR**), коммиты (**свободно**), ограничения (**нет**), внешние зависимости (MOEX/ЦБ + OpenSpec/Cursor/GitHub).
> - Привёл форматирование к требованиям markdown-lint (ошибок больше нет).
> - оставляю архитектуру “проекта с кодом” до первой спецификации. Я только чуть уточню в openspec/project.md, что этот пункт **сознательно отложен** и будет зафиксирован в первом change/spec, чтобы это не выглядело забытым TODO.

✅ Плюсы:

- Опросник достаточно хороший для инициализации проекта с нуля, интересно, как он поступит, если стартовать в проекте с уже существующим кодом;
- Как и просил - полностью на русском, хотя здесь может быть заслуга модели.
- Упомянуто, что для CI необходимо отделение интеграционных тестов с реальными системами от остальных для снижения влияния внешних факторов на прогон тестов.

❌ Минусы:

- Несмотря на то, что из файла JOURNAL.md он прочитал про Python 3.14.2 и явно это проговорил, в опросе в разделе технологии он об этом не упомянул и привел полный предполагаемый список технологий. В итоге раздел `стек` в конституции проекта продублирован, а Python 3.14.2 из JOURNAL.md снабжен комментарием `для запуска OpenSpec`;
- Cursor Pro и GitHub упомянуты дважды - как зависимости и как инфраструктура, OpenSpec - как часть текущего стека и как зависимость;
- не спросил, публичные ли источники или нужны учетные записи, в конституции записал в форме предположения;
- нет команды для создания конституции проекта, нужно написать приглашение полностью вручную. Правда, это делается один раз в проекте.

Итог: доделаю спеку вручную для упрощения работы в будущем.

#### Commit [215f301d6c7ca73f3a844fddd9dfc9b59c5d4c42](https://github.com/retverd/demo-open-spec-with-cursor/commit/215f301d6c7ca73f3a844fddd9dfc9b59c5d4c42)

Ручное обновление конституции проекта.

### Создание первого изменения

#### Commit [f845b20113f57ad89d8ef5b8a2fb59e0361f3de3](https://github.com/retverd/demo-open-spec-with-cursor/commit/f845b20113f57ad89d8ef5b8a2fb59e0361f3de3)

Начало работы над первым изменением:

```prompt
[Model GPT-5.2] /openspec-proposal сбор через API ЦБ РФ курса USDRUB. Интервал - последние 7 дней, текущий день - последний. Сохранять в файле формата parquet в локальную папку.
```

> **Готово: change создан и строго провалидирован**
>
> - Создан change-id: add-cbr-usdrub-parquet-export
> - Файлы изменения:
>   - openspec/changes/add-cbr-usdrub-parquet-export/proposal.md - короткое описание изменения: зачем оно нужно, что именно меняется, на что влияет, какие открытые вопросы остались. Это документ для обсуждения/одобрения.
>   - openspec/changes/add-cbr-usdrub-parquet-export/tasks.md - чеклист работ по изменению (спеки → реализация → тесты → документация/валидация). Используется как план выполнения после одобрения proposal.
>   - openspec/changes/add-cbr-usdrub-parquet-export/design.md - технические решения и компромиссы по изменению (контекст, цели/не цели, ключевые решения, риски, открытые вопросы). Нужен, чтобы договориться о подходе до кода.
>   - openspec/changes/add-cbr-usdrub-parquet-export/specs/cbr-usdrub/spec.md (ADDED requirements + сценарии) - дельта‑спека (требования и сценарии) для новой capability cbr-usdrub.
> - Валидация: openspec validate add-cbr-usdrub-parquet-export --strict проходит без ошибок.
> - Важно про язык требований: OpenSpec требует маркеры MUST/SHALL, поэтому я обновил openspec/project.md, чтобы это было зафиксировано как правило (при этом текст остаётся по-русски).

Без ручных правок

✅ Плюсы:

- сам актуализировал конституцию проекта по ходу выполнения задачи;
- мало файлов, довольно короткие;
- сформулировал хорошие вопросы для уточнения в [proposal.md](openspec/changes/add-cbr-usdrub-parquet-export/proposal.md) и риски в [design.md](openspec/changes/add-cbr-usdrub-parquet-export/design.md);
- весь текст на русском, на английском только отдельные слова;
- подготовлен план работ в [tasks.md](openspec/changes/add-cbr-usdrub-parquet-export/tasks.md), начинается с уточнения оставшихся вопросов по спецификации;
- запланировано обновление [README.md](README.md);
- в [spec.md](openspec/changes/add-cbr-usdrub-parquet-export/specs/cbr-usdrub/spec.md) исходный запрос переведен в требования, которые расписаны в проверяемые пользовательские истории.

❌ Минусы:

- изменение пока выглядит как очень монолитное, при этом в [design.md](openspec/changes/add-cbr-usdrub-parquet-export/design.md) явно указано, что универсальная поддержка всех валют/инструментов пока не запланирована:
  - изменение - add-cbr-usdrub-parquet-export;
  - спека - cbr-usdrub;
  - добавить модуль получения исторических значений USD/RUB от ЦБ РФ;
- на английском все-таки есть некоторые слова, видимо зашитые жестко в библиотеку;
- почти во всех файлах отсутствует заголовок первого уровня, что нарушает спецификацию md;
- структура датасета пока не определена, хотя, казалось бы, на этом этапе уже стоило бы определить;
- на этап design вынесены вопросы, хотя их логично было бы задать в начале.

#### Commit [b0702daf29373206a8b3663357ed369223e57635](https://github.com/retverd/demo-open-spec-with-cursor/commit/b0702daf29373206a8b3663357ed369223e57635)

Необходимо проверить все документы на готовность. Попробую через агента:

```prompt
[Model GPT-5.2] Проверь наличие открытых вопросов в спецификации @openspec/changes/add-cbr-usdrub-parquet-export. Если есть, давай ответим на них вместе.
```

После ответа на вопросы все документы обновлены, вопросов больше нет:

> **Открытые вопросы в change `add-cbr-usdrub-parquet-export`**
>
> - Были открыты (в [proposal.md](openspec/changes/add-cbr-usdrub-parquet-export/proposal.md) и [design.md](openspec/changes/add-cbr-usdrub-parquet-export/design.md)):
>   - Что делать, если за текущий день нет опубликованного курса;
>   - Путь выходной папки (фиксированный/настраиваемый)$;
>   - Имя файла и поведение при повторном запуске.
> - Теперь закрыты и зафиксированы в спеках/доках:
>   - Если за today нет значения: считаем результат частично успешным и сохраняем доступные значения.
>   - Папка сохранения: текущая папка (cwd).
>   - Имя файла: cbr_usdrub_YYYY-MM-DD_HHMMSS.parquet, где YYYY-MM-DD = локальный today, HHMMSS = локальное время запуска.
> - Что я обновил
>   - openspec/changes/add-cbr-usdrub-parquet-export/specs/cbr-usdrub/spec.md: обновил сценарии про папку и имя файла.
>   - openspec/changes/add-cbr-usdrub-parquet-export/proposal.md: перенёс “Open Questions” в “Решено”.
>   - openspec/changes/add-cbr-usdrub-parquet-export/design.md: добавил решения и убрал список открытых вопросов.
>   - openspec/changes/add-cbr-usdrub-parquet-export/tasks.md: заменил “уточнить” на “зафиксировать в спеках” по этим пунктам.
> - Проверка
>   - openspec validate add-cbr-usdrub-parquet-export --strict — валидно.

Также разбираюсь с рисками:

```prompt
[Model GPT-5.2] какие есть риски и предложения по их митигации?
...
[Model GPT-5.2] добавь в спецификацию и задачи те митигации, которых там ещё нет
```

> **Что добавлено в спецификацию (митигации)**
>
> В openspec/changes/add-cbr-usdrub-parquet-export/specs/cbr-usdrub/spec.md добавил отсутствующие митигации как требования/сценарии:
>
> - Таймауты и retries при вызове API ЦБ РФ
>   - В требование про получение данных добавлено: таймаут ≤ 10с на попытку и retries ≤ 3 на временные ошибки/5xx.
>   - Добавлен сценарий, что при временной ошибке система повторяет запрос и при успехе продолжает обработку.
>   - Сценарий “ошибка получения данных” уточнён: ошибка считается после исчерпания retries, и тогда файл не пишется.
> - Валидация данных перед записью
>   - Добавлено отдельное требование: валидировать данные перед сохранением.
>   - Сценарий: если rate отсутствует или rate ≤ 0 → ошибка и без записи Parquet.
>
> **Что добавлено в задачи (митигации)**
>
> В openspec/changes/add-cbr-usdrub-parquet-export/tasks.md добавил конкретные пункты:
>
> - Реализация
>   - Таймауты/повторные попытки (≤10с, ≤3).
>   - Валидация rate перед сохранением.
>   - Сохранение в cwd с именем `cbr_usdrub_YYYY-MM-DD_HHMMSS.parquet`.
>   - Pin Parquet-зависимостей + smoke-check записи/чтения.
> - Тестирование
>   - Unit-тесты на retries (временная ошибка → повтор → успех; и исчерпание retries → ошибка без записи).
>   - Unit-тесты на валидацию rate.
>   - Защита от сбоев: интеграционные тесты пометить маркером (например, integration) и сделать отключёнными по умолчанию.
>
> Проверки
>
> - openspec validate add-cbr-usdrub-parquet-export --strict — валидно.
> - Markdown-lint — без ошибок (добавил H1 в начало spec.md).

✅ Плюсы:

- найдены все открытые вопросы и разобраны риски, документация обновлена;
- частично покрыты негативные сценарии, можно дописать свои.

❌ Минусы:

- все приходится делать вручную, нехватает команд;
- часть команд приходится запускать не из агента типа `/openspec-...`, а через консоль, например, `openspec list`, `openspec validate ...`, `openspec show ...`. Рассматриваю добавление своих команд в инициализированный проект.
- в [proposal.md](openspec/changes/add-cbr-usdrub-parquet-export/proposal.md) ответы записаны в раздел **Open Questions**, а не **What Changes**.
- на этапе подготовки к имплементации так и не провел анализ реального API, как сделал Spec Kit в файле research.md. По итогам проверки можно было бы явно специфицировать рад нюансов, как, например, колонки в наборе данных.
- сам не создает ветки в git, хотя в спецификации явно указано работать через feature branches.

#### Commit [TBD](https://github.com/retverd/demo-open-spec-with-cursor/commit/TBD)

Реализация спецификации и проверка:

```prompt
[Model GPT-5.1 Codex Max] /openspec-apply
```

> Что сделано (apply):
>
> - Реализован сбор USD/RUB за последние 7 дней с API ЦБ РФ с таймаутами/retries, валидацией курса и сохранением в Parquet в текущую папку; добавлен CLI [cbr_usdrub_fetcher.py](cbr_usdrub_fetcher.py).
> - Добавлены зависимости [requirements.txt](requirements.txt), конфиг pytest [pytest.ini](pytest.ini), [conftest.py](conftest.py) и тесты: unit (парсинг/диапазон, имя файла, retries, валидация) и интеграционный (реальный вызов ЦБ РФ, отмечен **@integration** и по умолчанию скипается).
> - Обновлён [README.md](README.md) с инструкцией запуска и тестов; все пункты [tasks.md](openspec/changes/add-cbr-usdrub-parquet-export/tasks.md) по change помечены выполненными; change снова проходит `openspec validate --strict`.
>
> Тесты:
>
> - Unit: не запускались — установка зависимостей в `.venv` упала при сборке `pandas`/`numpy` (нет готовых wheels для Python 3.14, требуется инструменты сборки/совместимая версия Python). Интеграционный тест аналогично не прогонялся.
> - Что нужно для прогонки: либо поставить поддерживаемый Python (например, 3.11) и `pip install -r requirements.txt`, либо установить инструменты сборки под Windows/дождаться готовых wheels, затем `pytest -m "not integration"` и при необходимости `PYTEST_RUN_INTEGRATION=1 pytest -m integration`.
>
> Основные файлы:
>
> - [cbr_usdrub_fetcher.py](cbr_usdrub_fetcher.py) — логика получения, повторные попытки, валидация, запись Parquet, CLI.
> - [test_cbr_usdrub.py](tests/test_cbr_usdrub.py), [pytest.ini](pytest.ini), [conftest.py](conftest.py) — тесты + маркировка интеграционных тестов.
> - [requirements.txt](requirements.txt), [README.md](README.md), [add-cbr-usdrub-parquet-export](openspec/changes/add-cbr-usdrub-parquet-export/) — обновлённые зависимости, инструкция и статусы задач.
>
> Если нужно, могу попробовать установить зависимости через другой Python/инструменты сборки или прогнать тесты после их появления.

```prompt
[Model GPT-5.1 Codex Max] Я установил необходимые библиотеки, закончи открытые задачи
```

✅ Плюсы:

- написаны код и тесты;
- была попытка прогнать тесты, но из-за некорректных версий библиотек в [requirements.txt](requirements.txt) тесты не были запущены;
- после актуализации библиотек в [requirements.txt](requirements.txt) и их установки, успешно запустил все тесты, исправил ошибку в одном из тестов и проставил все задачи как выполненные;
- код действительно работает - при выполнении интеграционного теста parquet-файл с ожидаемыми данными сохранился.

❌ Минусы:

- не создана структура проекта, видимо, надо указывать явно;
- в [requirements.txt](requirements.txt) почему-то указаны очень старые версии библиотек, указанные версии не годятся для Python 3.14, новые версии прекрасно установились:
  - httpx==0.25.2 -> уже есть 0.28.1;
  - pandas==2.1.4 -> уже есть 2.3.3;
  - pyarrow==14.0.2 -> уже есть 22.0.0;
  - pytest==7.4.4 -> уже есть 9.0.2.
- несмотря на то, что он прекрасно знает, что я работает под Win, предложил нерабочую версию запуска тестов `PYTEST_RUN_INTEGRATION=1 pytest -m integration`, хотя надо `$env:PYTEST_RUN_INTEGRATION=1; python -m pytest -m integration`;
- Pyright обнаружил недостижимый код, некоторые выражения в [test_cbr_usdrub.py](tests/test_cbr_usdrub.py) вызывают предупреждения и ошибки;
- не все сообщения на русском;
- в тестах не проверяются сообщения об ошибках, только классы исключений;
- как писалось в требованиях, класс монолитный, валютная пара зашита в него, а не передается параметром;
- выбран некорректный интерфейс сбора - данные собираются не с официального сайта, а с левого сайта <https://www.cbr-xml-daily.ru>. Данные выгружаются перебором дней, а не интервалом. Очень не хватило предварительной проработки.
