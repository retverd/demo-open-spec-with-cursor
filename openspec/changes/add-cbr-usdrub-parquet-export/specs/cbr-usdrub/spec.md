# Спецификация capability `cbr-usdrub` (дельта change)

## ADDED Requirements

### Requirement: Получение курса USD/RUB от ЦБ РФ за последние 7 дней

Система MUST получать официальный курс USD/RUB от ЦБ РФ за диапазон дат \([today-6; today]\), где `today` — текущая локальная календарная дата запуска.
Система MUST выполнять запросы к источнику с таймаутом на одну попытку НЕ БОЛЕЕ 10 секунд и с повторными попытками (retries) НЕ БОЛЕЕ 3 при временных ошибках сети и/или ответах источника уровня 5xx.

#### Scenario: Успешное получение данных за весь диапазон

- **WHEN** система запрашивает данные у ЦБ РФ за диапазон \([today-6; today]\)
- **THEN** система ДОЛЖНА получить набор значений курса в указанном диапазоне
- **AND THEN** набор ДОЛЖЕН содержать значения за все даты в диапазоне, которые возвращает источник

#### Scenario: За текущий день нет опубликованного значения

- **WHEN** система запрашивает данные у ЦБ РФ за диапазон \([today-6; today]\)
- **AND WHEN** источник не возвращает значение за `today`
- **THEN** система ДОЛЖНА считать результат частично успешным
- **AND THEN** система ДОЛЖНА продолжить обработку и сохранить все доступные значения в диапазоне

#### Scenario: Ошибка получения данных (сетевой сбой/ошибка источника)

- **WHEN** система запрашивает данные у ЦБ РФ за диапазон \([today-6; today]\)
- **AND WHEN** все повторные попытки исчерпаны и запрос к источнику завершается ошибкой
- **THEN** система ДОЛЖНА завершиться с ошибкой
- **AND THEN** система НЕ ДОЛЖНА записывать новый выходной Parquet-файл

#### Scenario: Временная ошибка источника, восстановление после повторной попытки

- **WHEN** система запрашивает данные у ЦБ РФ за диапазон \([today-6; today]\)
- **AND WHEN** первая попытка завершается временной ошибкой сети и/или 5xx от источника
- **THEN** система ДОЛЖНА выполнить повторные попытки (retries)
- **AND THEN** при успешной повторной попытке система ДОЛЖНА продолжить обработку и сохранить результат

### Requirement: Сохранение истории курса в Parquet в локальную папку

Система MUST сохранять полученную историю курса USD/RUB в **Parquet** файл в текущую папку (cwd).

#### Scenario: Сохранение в текущую папку

- **WHEN** система сохраняет Parquet-файл
- **THEN** файл ДОЛЖЕН быть сохранён в текущую папку (cwd)

#### Scenario: Имя выходного файла детерминировано и привязано к конечной дате

- **WHEN** система сохраняет результат за диапазон \([today-6; today]\)
- **THEN** имя выходного файла ДОЛЖНО быть `cbr_usdrub_YYYY-MM-DD_HHMMSS.parquet`
- **AND THEN** `YYYY-MM-DD` ДОЛЖНО соответствовать значению `today`
- **AND THEN** `HHMMSS` ДОЛЖНО соответствовать локальному времени запуска (в момент старта выполнения)

#### Scenario: Минимальная схема данных в Parquet

- **WHEN** система сохраняет историю курса в Parquet
- **THEN** Parquet ДОЛЖЕН содержать минимум следующие поля: `date`, `pair`, `rate`, `source`, `retrieved_at`
- **AND THEN** `pair` ДОЛЖНО быть равно `USD/RUB`
- **AND THEN** `source` ДОЛЖНО быть равно `CBR`

### Requirement: Валидация данных перед сохранением

Система MUST валидировать полученные значения курса перед сохранением в Parquet.

#### Scenario: Некорректное значение курса

- **WHEN** система получает данные курса от источника
- **AND WHEN** хотя бы одно значение `rate` некорректно (например, отсутствует или меньше либо равно 0)
- **THEN** система ДОЛЖНА завершиться с ошибкой
- **AND THEN** система НЕ ДОЛЖНА записывать новый выходной Parquet-файл
